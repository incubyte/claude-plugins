# Spec: /bee:architect Phase 2 — Greenfield Boundary Awareness via BOUNDARIES.md

## Overview

When `/bee:build` handles a greenfield project whose discovery produces a module structure, a `.claude/BOUNDARIES.md` file is generated as a project-level artifact — like `.claude/DESIGN.md` for design. All downstream agents reference it when writing code, ensuring module boundaries are respected from the first line. No separate test generation step, no pipeline gate, no overhead at project start.

For brownfield projects, `/bee:architect` standalone (Phase 1) already handles assessment and arch test generation. This phase does NOT change Phase 1.

## The Insight

Architecture boundaries should work like the design brief — ambient knowledge, not a pipeline step. Claude just *knows* "payments must not import from orders" while writing any code in any phase, the same way it knows "use 4.5:1 contrast ratio" from design-fundamentals.

## Acceptance Criteria

### Discovery Module Structure Output (agents/discovery.md)

- [ ] When discovery detects a greenfield project (from context-gatherer "greenfield" signal or empty repo), the PRD includes a "Module Structure" section after the Milestone Map
- [ ] Each module entry lists the module name, the domain concepts it owns, and its allowed dependencies
- [ ] The Module Structure section is derived from the capabilities in the Milestone Map (not invented independently)
- [ ] When discovery detects a non-greenfield project, the Module Structure section is omitted

### BOUNDARIES.md Generation (commands/build.md)

- [ ] After discovery completes on a greenfield project, build.md checks whether the discovery document contains a Module Structure section
- [ ] When Module Structure is present, build.md generates `.claude/BOUNDARIES.md` from the Module Structure
- [ ] Build.md asks the developer for consent before creating the file: "Want me to save these module boundaries so Claude respects them in all code it writes?" (same pattern as design agent's CLAUDE.md consent)
- [ ] If CLAUDE.md exists and doesn't already reference BOUNDARIES.md, build.md asks: "Want me to add a reference to BOUNDARIES.md in your CLAUDE.md so Claude always has boundary context?"
- [ ] Build.md reports to the developer what was generated: which modules, which boundaries
- [ ] When Module Structure is absent (non-greenfield or discovery skipped), build.md skips boundary generation entirely — no change to existing behavior
- [ ] State file is updated with boundaries path (`.claude/BOUNDARIES.md`)

### BOUNDARIES.md Format

- [ ] File includes a Module Boundaries section listing each module, its owned concepts, and allowed dependencies
- [ ] File includes a Rules section with universal boundary rules (no circular deps, concepts live in owning module, import only from declared deps)
- [ ] File includes a "Generated by" header noting it came from discovery and can be manually edited
- [ ] Format is simple markdown readable by any agent without parsing logic

### Downstream Agent Awareness

- [ ] TDD planners (all 5) check for `.claude/BOUNDARIES.md` before generating plans and respect boundaries in step structure
- [ ] spec-builder checks for `.claude/BOUNDARIES.md` and uses module boundaries to inform acceptance criteria (e.g., "payment logic lives in payments module")
- [ ] architecture-advisor checks for `.claude/BOUNDARIES.md` and validates that the chosen architecture pattern is compatible with declared boundaries
- [ ] quick-fix checks for `.claude/BOUNDARIES.md` — even trivial fixes should not violate boundaries
- [ ] verifier checks for `.claude/BOUNDARIES.md` during post-slice verification and flags boundary violations

### Retroactive Changes from Phase 1

- [ ] architecture-test-writer.md: remove the greenfield mode section (Steps that accepted Module Structure as alternative input). The agent stays brownfield-only — it receives assessment reports, not module maps
- [ ] architect.md command: remove any references to greenfield integration. Add a note: "For greenfield projects, boundaries are managed via `.claude/BOUNDARIES.md` generated during `/bee:build` discovery"

### Error Handling

- [ ] If discovery produces a Module Structure but the developer declines to create BOUNDARIES.md, build.md proceeds normally without it — boundaries are valuable but not blocking
- [ ] If `.claude/BOUNDARIES.md` already exists (from a previous discovery run), build.md asks whether to update or keep existing: "Existing boundaries found. Update with new module structure or keep current?"

## Module Structure Shape

The discovery agent adds this section for greenfield projects:

```markdown
## Module Structure

- `orders/` — owns: Order, LineItem. Depends on: (none)
- `payments/` — owns: Payment, Invoice. Depends on: orders
- `notifications/` — owns: Notification, Template. Depends on: orders, payments
```

## BOUNDARIES.md Shape

```markdown
# Module Boundaries

> Generated by /bee:discover from the project's milestone map.
> Edit this file to adjust boundaries as the project evolves.

## Modules

- `orders/` — owns: Order, LineItem. Depends on: (none)
- `payments/` — owns: Payment, Invoice. Depends on: orders
- `notifications/` — owns: Notification, Template. Depends on: orders, payments

## Rules

- Modules may only import from declared dependencies
- Domain concepts live in their owning module — do not scatter across modules
- No circular dependencies
- When in doubt, duplicate code rather than create a coupling that violates boundaries
```

## Out of Scope

- Modifying the standalone `/bee:architect` command flow (Phase 1 stays as-is for brownfield)
- Generating runnable arch test files from BOUNDARIES.md (the boundary enforcement is ambient, not test-based — `/bee:architect` standalone still generates tests for brownfield)
- Updating BOUNDARIES.md when new phases add modules (future consideration — for now it's created once from initial discovery)
- Class-level or function-level boundary rules (module-level only)
- Enforcing boundaries at CI level (this is development-time guidance, not a gate)

## Technical Context

- **Files to modify**: `agents/discovery.md` (add Module Structure output for greenfield), `commands/build.md` (add BOUNDARIES.md generation after discovery), all 5 TDD planners + `spec-builder.md` + `architecture-advisor.md` + `quick-fix.md` + `verifier.md` (add BOUNDARIES.md read step)
- **Files to retroactively update**: `agents/architecture-test-writer.md` (remove greenfield mode), `commands/architect.md` (add note about greenfield handled by BOUNDARIES.md)
- **Pattern to follow**: Identical to `.claude/DESIGN.md` — design-agent creates it, build.md asks for CLAUDE.md reference, downstream agents check for it before producing output
- **Key integration point**: build.md already checks discovery output for phase count and size revision. The Module Structure check is the same pattern — read the discovery doc, look for the section, act on it
- **Agent constraint**: No new agents needed. Discovery adds a section, build.md generates the file, existing agents read it
- **Risk level**: LOW (internal developer tooling, additive change, existing behavior unaffected when boundaries are absent)

[ ] Reviewed
